<html>
<head>
  <meta charset="UTF-8">
  <style>
    #appDebugPanel {
      position: sticky;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      top: 0px;
      padding: 8px;
      background: whitesmoke;
    }
    html,body {
      padding: 0px;
      margin: 0px;
    }
  </style>
	<link rel="stylesheet" type="text/css" href="./test.css">
</head>
<body>
  <inspect id="appDebugPanel"></inspect>
  <script src="imbac.js" type="text/javascript"></script>
  <script src="imba.js" type="text/javascript"></script>
  <script>
    require = function(name){ if(name == 'imba2'){ return Imba; } }
    this.global = this;
  </script>
  <script src="runner.js" type="text/javascript"></script>
  <script>
  SELF = {
    test: window.test,
    describe: window.describe,
    eq: window.eq,
    ok: window.ok,
    spec: SPEC
  }
  // console.log("SELF is",SELF);

  window.onerror = function(e){
    console.log("ERROR",e);
  }

  window.onunhandledrejection = function(e){
    console.log('page:error',{message: e.reason.message});
  }
  var self = SELF;

  var load = async function(src){
  	var url = './' + src;
  	var req = await fetch(url,{mode: 'no-cors'});
  	var res = await req.text();

    if(src.indexOf('.js') > 0){
      // run(res);
      var script = document.createElement('script');
      script.src = url;
      document.head.appendChild(script);
      // document.write(`<script src=${url}><\/script>`);
    } else {
      compileAndRun(src,res);  
    }
  }

  var compileAndRun = async function(src, body){
    var result = imbac.compile(body);
    var js = result.js;
    run(js);
  }

  var run = function(js){
    js = js.replace(/require\(["']imba2?["']\)/g,'window.Imba');
  	js = js.replace('self = {}','self = SELF');
  	eval(js);

    var exposed = self;

    if(SPEC.blocks.length){
      exposed = {test: SPEC.run.bind(SPEC) }
      SPEC.blocks.forEach(function(v){
        exposed[v.name] = v.run.bind(v);
      })
    }

    for(let key of Object.keys(exposed)) {
      let val = exposed[key];
      // console.log(key);
      if(val instanceof Function){
        var button = document.createElement('button');
        button.textContent = key;
        button.onclick = function(){
          val.call(self);
          Imba.commit();
        }
        window.appDebugPanel.appendChild(button);
      }
    }
    console.log('example:loaded',10);
  }
  var hash = (document.location.hash || '').slice(1);
  if(hash){ load(hash) }
</script>
</body>
</html>