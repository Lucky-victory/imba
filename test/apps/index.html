<html>
<head>
  <style>
    #appDebugPanel {
      position: sticky;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      top: 0px;
      padding: 8px;
      background: whitesmoke;
    }
    html,body {
      padding: 0px;
      margin: 0px;
    }
  </style>
	<link rel="stylesheet" type="text/css" href="./test.css">
</head>
<body>
  <inspect id="appDebugPanel"></inspect>
  <script src="../imbac.js" type="text/javascript"></script>
  <script src="../imba.js" type="text/javascript"></script>
  <script>
    require = function(name){ if(name == 'imba2'){ return Imba; } }
    this.global = this;
  </script>
  <script src="../runner.js" type="text/javascript"></script>
  <script>
  SELF = {}
  var self = SELF;

  var load = async function(src){
  	// console.log('start with',src);
  	// document.write(`<script id='aba' src='${src}.js'><\/script>`);
  	// document.write(`<link rel='import' id='a2ba' href='${src}.js'><\/link>`);
  	// var root = document.location.href.split('index.html')[0];
  	// var url = 'http://localhost:8125/' + src + '.imba'
  	var url = './' + src;
  	var req = await fetch(url,{mode: 'no-cors'});
  	var res = await req.text();

    if(src.indexOf('.js') > 0){
      // run(res);
      var script = document.createElement('script');
      script.src = url;
      document.head.appendChild(script);
      // document.write(`<script src=${url}><\/script>`);
    } else {
      compileAndRun(src,res);  
    }
  }

  var compileAndRun = async function(src, body){
    var result = imbac.compile(body);
    var js = result.js;
    run(js);
  }

  var run = function(js){
    js = js.replace(/require\(["']imba2?["']\)/g,'window.Imba');
  	js = js.replace('var self = {}','var self = SELF');
    // console.log('running',js);
  	eval(js);
    // console.log('self is',SELF);
    // var panel = document.createElement('inspect');
    for(let key of Object.keys(self)) {
      let val = self[key];
      console.log(key);
      if(val instanceof Function){
        var button = document.createElement('button');
        button.textContent = key;
        button.onclick = function(){
          val.call(self);
          Imba.commit();
        }
        window.appDebugPanel.appendChild(button);
      }
    }
  }
  var hash = (document.location.hash || '').slice(1);
  if(hash){ load(hash) }
</script>
</body>
</html>